<div class="flex flex-col w-full h-full">
    <!-- Main Content Area - Chat Messages -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden flex flex-col px-4 md:px-8 py-6 min-h-0">
        @if (!selectedChat() && !isLoading()) {
        <!-- Welcome Screen -->
        <app-vera-welcome class="flex-1"></app-vera-welcome>
        } @else {
        <!-- Chat Messages Display -->
        <div class="flex flex-col space-y-4">
            @if (selectedChat()) {
            <!-- User Message -->
            <div class="flex justify-end">
                <div class="max-w-xs md:max-w-md bg-vera-primary text-neutrals-900 rounded-2xl rounded-tr-sm px-4 py-3">
                    <!-- Media Preview -->
                    @if (selectedChat()!.media) {
                    <div class="mb-3">
                        @if (selectedChat()!.media!.type === 'image') {
                        <img [src]="selectedChat()!.media!.preview" [alt]="selectedChat()!.media!.name"
                            class="rounded-lg max-w-xs h-auto" />
                        } @else if (selectedChat()!.media!.type === 'video') {
                        <video [src]="selectedChat()!.media!.preview" controls
                            class="rounded-lg max-w-xs h-auto"></video>
                        } @else if (selectedChat()!.media!.type === 'audio') {
                        <audio [src]="selectedChat()!.media!.preview" controls class="rounded-lg w-full"></audio>
                        }
                    </div>
                    }
                    <!-- User Question Text -->
                    <p class="text-sm break-words whitespace-pre-wrap">{{ selectedChat()!.question }}</p>
                    <!-- Timestamp -->
                    <p class="text-xs mt-2 opacity-70">
                        {{ selectedChat()!.date | date: 'short' }}
                    </p>
                </div>
            </div>
            }

            <!-- Loading State with Skeleton -->
            @if (isLoading()) {
            <app-vera-skeleton></app-vera-skeleton>
            }

            <!-- Error State -->
            @if (error()) {
            <div class="flex justify-start">
                <div class="max-w-xs md:max-w-md bg-red-50 border border-red-200 rounded-2xl rounded-tl-sm px-4 py-3">
                    <p class="text-sm text-red-500 font-medium">{{ error() }}</p>
                </div>
            </div>
            }

            <!-- Response Message -->
            @if (response() && !isLoading()) {
            <div class="flex justify-start w-full">
                <div class="w-full max-w-4xl flex flex-col gap-2">
                    <!-- Answer Text -->
                    <div class="text-sm text-neutrals-900 break-words whitespace-pre-wrap leading-relaxed bg-neutrals-50 border border-neutrals-200 rounded-2xl px-4 py-3"
                        [class]="(response()!.extractedLinks?.length ?? 0) > 0 ? 'rounded-2xl' : 'rounded-bl-sm'">
                        <p class="w-full break-words" [innerHTML]="formatResponseWithLinks(response()!.answer)"></p>
                        <!-- Timestamp -->
                        <p class="text-xs text-neutrals-900 flex justify-end mt-2">
                            {{ response()!.timestamp | date: 'short' }}
                        </p>
                    </div>

                    <!-- Links Section Integrated in Response -->
                    @if ((response()?.extractedLinks?.length ?? 0) > 0) {
                    <div class="w-full">
                        <div class="flex flex-col gap-2">
                            @for (link of response()!.extractedLinks!; track $index) {
                            <div class="p-3 transition-colors bg-neutrals-50 border border-neutrals-200 rounded-2xl px-4 py-3 w-full"
                                [class]="$last ? 'rounded-bl-sm' : 'rounded-2xl'">
                                <div class="flex items-start gap-2 min-w-0">
                                    <img [src]="getFaviconUrl(link)" [alt]="getDomain(link) + ' favicon'"
                                        class="w-5 h-5 flex-shrink-0 rounded" (error)="onImageError($event)" />
                                    <div class="flex-1 min-w-0">
                                        <a [href]="link" target="_blank" rel="noopener noreferrer"
                                            class="text-green-600 hover:underline font-medium break-all block text-xs w-full">
                                            {{ link }}
                                        </a>
                                        <div class="mt-0.5 text-xs text-green-900 break-all">
                                            {{ getDomain(link) }}
                                        </div>
                                    </div>
                                </div>
                                <!-- Timestamp -->
                                <p class="text-xs text-neutrals-900 flex justify-end mt-2">
                                    {{ response()!.timestamp | date: 'short' }}
                                </p>
                            </div>
                            }
                        </div>
                    </div>
                    }

                    <!-- Copy Button -->
                    <button (click)="copyResponse(response()!.answer)"
                        class="flex w-full justify-end gap-2 text-xs text-neutrals-600 hover:text-neutrals-900 transition-colors mt-2">
                        <vera-icon name="copy" [size]="16"></vera-icon>
                    </button>
                </div>
            </div>
            }
        </div>
        }
    </main>

    <!-- Input Area - Hidden when viewing a response -->
    @if (!response()) {
    <div class="flex-shrink-0">
        <app-vera-input (submitWithFile)="onSubmitQuestion($event)" [isLoading]="isLoading()"
            [initialQuestion]="initialQuestion()"></app-vera-input>
    </div>
    }

    <!-- Toast Notification for Copy -->
    @if (showCopyToast()) {
    <div
        class="fixed bottom-6 right-6 bg-vera-primary text-neutrals-900 px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-fade-in">
        <vera-icon name="check" [size]="18"></vera-icon>
        <span class="text-sm font-medium">{{ 'vera.response.copied' | translate }}</span>
    </div>
    }
</div>